# Notion Update Sequence Tracker Task (CRITICAL)
# Update Notion Sequence Tracker database after EVERY email send
# This task is called by send_email_flow and all handler flows
#
# Inputs:
#   - sequence_id: Notion page ID of email sequence record
#   - email_number: Email number (2-5 for 5-day, 1-3 for secondary sequences)
#   - sent_at: ISO 8601 timestamp when email was sent
#   - status: Email status ('sent' or 'failed')
#   - resend_id: Resend API email ID (from Resend response)
#   - sent_by: Who sent the email ('kestra' or 'website')
#   - sequence_type: Type of sequence ('5day', 'noshow', 'postcall', 'onboarding')
#
# Outputs:
#   - response: Updated Notion page
#
# Error Handling:
#   - Graceful failure: Logs error but returns success
#   - Email delivery takes priority over Notion tracking
#
# Author: Kestra Migration Team
# Created: 2025-11-29
# Feature: 2.8 (Dedicated Notion Sequence Tracker update task)

id: notion_update_sequence_tracker
type: io.kestra.plugin.core.http.Request
uri: "https://api.notion.com/v1/pages/{{ inputs.sequence_id }}"
method: PATCH
headers:
  Authorization: "Bearer {{ secret('NOTION_TOKEN') }}"
  Notion-Version: "2022-06-28"
  Content-Type: "application/json"
contentType: application/json
body: |
  {
    "properties": {
      "Email {{ inputs.email_number }} Sent": {
        "date": {
          "start": "{{ inputs.sent_at }}"
        }
      },
      "Email {{ inputs.email_number }} Status": {
        "select": {
          "name": "{{ inputs.status | default('sent') }}"
        }
      },
      "Email {{ inputs.email_number }} Resend ID": {
        "rich_text": [
          {
            "text": {
              "content": "{{ inputs.resend_id | default('') }}"
            }
          }
        ]
      },
      "Email {{ inputs.email_number }} Sent By": {
        "select": {
          "name": "{{ inputs.sent_by | default('kestra') }}"
        }
      },
      "Last Email Sent": {
        "number": {{ inputs.email_number }}
      },
      "Last Email Sent At": {
        "date": {
          "start": "{{ inputs.sent_at }}"
        }
      }
    }
  }
# Graceful error handling
allowFailed: true
logLevel: WARN
