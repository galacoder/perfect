# Christmas Campaign - Signup Handler Flow
# TRACKING ONLY - NO EMAIL SENDING
#
# CRITICAL: This handler does NOT send any emails. Website handles signup email directly.
# Kestra responsibilities:
#   1. Parse webhook payload (email, name, first_name, business_name)
#   2. Create or update contact record in Notion
#   3. Log signup event for analytics
#   4. Return success (NO email scheduling)
#
# NOTE: This flow creates new contacts unconditionally. Notion email property
# should be unique to prevent duplicates (handled by Notion side).
#
# Author: Kestra Migration Team
# Created: 2025-11-30
# Ported from: campaigns/christmas_campaign/flows/signup_handler.py

id: signup-handler
namespace: christmas
description: Handle Christmas campaign signup - tracking only, NO email sending

triggers:
  - id: webhook_trigger
    type: io.kestra.plugin.core.trigger.Webhook
    key: christmas-signup-webhook

variables:
  email: "{{ trigger.body.email }}"
  name: "{{ trigger.body.name ?? trigger.body.first_name ?? 'Unknown' }}"
  first_name: "{{ trigger.body.first_name ?? 'Unknown' }}"
  business_name: "{{ trigger.body.business_name ?? '' }}"

tasks:
  # Step 1: Log incoming signup
  - id: log_incoming
    type: io.kestra.plugin.core.log.Log
    message: |
      üì• Processing signup for {{ vars.email }}
      - Name: {{ vars.first_name }}
      - Business: {{ vars.business_name }}
    level: INFO

  # Step 2: Create contact in Notion (Notion handles duplicates via email uniqueness)
  - id: create_or_update_contact
    type: io.kestra.plugin.core.http.Request
    uri: "https://api.notion.com/v1/pages"
    method: POST
    headers:
      Authorization: "Bearer {{ secret('NOTION_TOKEN') }}"
      Notion-Version: "2022-06-28"
      Content-Type: "application/json"
    contentType: application/json
    body: |
      {
        "parent": {
          "database_id": "{{ secret('NOTION_CONTACTS_DB_ID') }}"
        },
        "properties": {
          "first_name": {
            "title": [
              {
                "text": {
                  "content": "{{ vars.first_name }}"
                }
              }
            ]
          },
          "email": {
            "email": "{{ vars.email }}"
          },
          "last_name": {
            "rich_text": [
              {
                "text": {
                  "content": "{{ vars.business_name }}"
                }
              }
            ]
          },
          "Christmas Campaign Status": {
            "select": {
              "name": "Signed Up"
            }
          }
        }
      }

  # Step 3: Log success
  - id: log_signup_event
    type: io.kestra.plugin.core.log.Log
    message: |
      ‚úÖ Signup processed for {{ trigger.body.email }}
      - Name: {{ trigger.body.first_name ?? 'Unknown' }}
      - Business: {{ trigger.body.business_name ?? '' }}
      - Campaign: Christmas 2025
      - Status: Contact created successfully

      üö® CRITICAL: NO emails sent by Kestra (website handles signup email)
    level: INFO

errors:
  - id: log_error
    type: io.kestra.plugin.core.log.Log
    message: "‚ùå Error processing signup for {{ trigger.body.email }}: {{ error.message ?? 'Unknown error' }}"
    level: ERROR
