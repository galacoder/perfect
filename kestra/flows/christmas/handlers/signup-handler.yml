# Christmas Campaign - Signup Handler Flow
# TRACKING ONLY - NO EMAIL SENDING
#
# CRITICAL: This handler does NOT send any emails. Website handles signup email directly.
# Kestra responsibilities:
#   1. Parse webhook payload (email, name, first_name, business_name)
#   2. Search for existing contact in Notion Contacts database
#   3. Create or update contact record
#   4. Log signup event for analytics
#   5. Return success (NO email scheduling)
#
# Author: Kestra Migration Team
# Created: 2025-11-30
# Ported from: campaigns/christmas_campaign/flows/signup_handler.py

id: signup-handler
namespace: christmas.campaign
description: Handle Christmas campaign signup - tracking only, NO email sending

triggers:
  - id: webhook_trigger
    type: io.kestra.plugin.core.trigger.Webhook
    key: christmas-signup-webhook

inputs:
  - id: email
    type: STRING
    description: Contact email address
    required: true
  - id: name
    type: STRING
    description: Contact full name
    required: false
  - id: first_name
    type: STRING
    description: Contact first name
    required: false
  - id: business_name
    type: STRING
    description: Business name
    required: false

tasks:
  # Step 1: Search for existing contact in Notion Contacts database
  - id: search_contact
    type: io.kestra.plugin.core.http.Request
    uri: "https://api.notion.com/v1/databases/{{ secret('SECRET_NOTION_CONTACTS_DB_ID') }}/query"
    method: POST
    headers:
      Authorization: "Bearer {{ secret('SECRET_NOTION_TOKEN') }}"
      Notion-Version: "2022-06-28"
      Content-Type: "application/json"
    contentType: application/json
    body: |
      {
        "filter": {
          "property": "Email",
          "email": {
            "equals": "{{ inputs.email }}"
          }
        }
      }

  # Step 2: Check if contact already exists (idempotency)
  - id: check_existing_contact
    type: io.kestra.plugin.core.execution.If
    condition: "{{ outputs.search_contact.body.results | length > 0 }}"
    then:
      # Contact exists - update it
      - id: log_existing_contact
        type: io.kestra.plugin.core.log.Log
        message: "Contact already exists for {{ inputs.email }}. Updating existing record."
        level: INFO

      - id: update_contact
        type: io.kestra.plugin.core.http.Request
        uri: "https://api.notion.com/v1/pages/{{ outputs.search_contact.body.results[0].id }}"
        method: PATCH
        headers:
          Authorization: "Bearer {{ secret('SECRET_NOTION_TOKEN') }}"
          Notion-Version: "2022-06-28"
          Content-Type: "application/json"
        contentType: application/json
        body: |
          {
            "properties": {
              "Name": {
                "title": [
                  {
                    "text": {
                      "content": "{{ inputs.name ?? inputs.first_name ?? 'Unknown' }}"
                    }
                  }
                ]
              },
              "Business Name": {
                "rich_text": [
                  {
                    "text": {
                      "content": "{{ inputs.business_name ?? '' }}"
                    }
                  }
                ]
              },
              "Last Signup": {
                "date": {
                  "start": "{{ now() }}"
                }
              }
            }
          }
    else:
      # Contact doesn't exist - create new one
      - id: log_new_contact
        type: io.kestra.plugin.core.log.Log
        message: "Creating new contact for {{ inputs.email }}"
        level: INFO

      - id: create_contact
        type: io.kestra.plugin.core.http.Request
        uri: "https://api.notion.com/v1/pages"
        method: POST
        headers:
          Authorization: "Bearer {{ secret('SECRET_NOTION_TOKEN') }}"
          Notion-Version: "2022-06-28"
          Content-Type: "application/json"
        contentType: application/json
        body: |
          {
            "parent": {
              "database_id": "{{ secret('SECRET_NOTION_CONTACTS_DB_ID') }}"
            },
            "properties": {
              "Name": {
                "title": [
                  {
                    "text": {
                      "content": "{{ inputs.name ?? inputs.first_name ?? 'Unknown' }}"
                    }
                  }
                ]
              },
              "Email": {
                "email": "{{ inputs.email }}"
              },
              "Business Name": {
                "rich_text": [
                  {
                    "text": {
                      "content": "{{ inputs.business_name ?? '' }}"
                    }
                  }
                ]
              },
              "Signup Date": {
                "date": {
                  "start": "{{ now() }}"
                }
              },
              "Campaign": {
                "select": {
                  "name": "Christmas 2025"
                }
              }
            }
          }

  # Step 3: Log signup event for analytics
  - id: log_signup_event
    type: io.kestra.plugin.core.log.Log
    message: |
      âœ… Signup processed for {{ inputs.email }}
      - Name: {{ inputs.name ?? inputs.first_name ?? 'Unknown' }}
      - Business: {{ inputs.business_name ?? 'Not provided' }}
      - Action: {{ outputs.search_contact.body.results | length > 0 ? 'Updated' : 'Created' }}
      - Campaign: Christmas 2025

      ğŸš¨ CRITICAL: NO emails sent by Kestra (website handles signup email)
    level: INFO

errors:
  - id: log_error
    type: io.kestra.plugin.core.log.Log
    message: "âŒ Error processing signup for {{ inputs.email }}: {{ error.message }}"
    level: ERROR
